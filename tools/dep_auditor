#!/bin/bash
# Dependency Auditor - Security audit for dependencies
# SPAI Dev Tool

set -euo pipefail

usage() {
    cat <<EOF
Dependency Auditor - Security audit for dependencies

Usage: dep_auditor [OPTIONS]

OPTIONS:
    -l, --lang LANG     Force language (rust, python, js, go)
    -f, --fix           Auto-fix vulnerabilities where possible
    -u, --update        Update dependencies
    --json              JSON output
    -h, --help          Show this help

SUPPORTED:
    Rust: cargo-audit
    Python: pip-audit, safety
    JavaScript: npm audit
    Go: govulncheck

EXAMPLES:
    dep_auditor
    dep_auditor -l python
    dep_auditor --fix
EOF
}

LANG=""
FIX=0
UPDATE=0
JSON_OUT=0

while [[ $# -gt 0 ]]; do
    case $1 in
        -l|--lang) LANG="$2"; shift 2 ;;
        -f|--fix) FIX=1; shift ;;
        -u|--update) UPDATE=1; shift ;;
        --json) JSON_OUT=1; shift ;;
        -h|--help) usage; exit 0 ;;
        *) shift ;;
    esac
done

echo "═══════════════════════════════════════════════════════════════"
echo "   SPAI Dependency Auditor"
echo "═══════════════════════════════════════════════════════════════"
echo ""

# Auto-detect language
detect_lang() {
    if [ -f "Cargo.toml" ]; then
        echo "rust"
    elif [ -f "pyproject.toml" ] || [ -f "requirements.txt" ] || [ -f "setup.py" ]; then
        echo "python"
    elif [ -f "package.json" ]; then
        echo "javascript"
    elif [ -f "go.mod" ]; then
        echo "go"
    else
        echo "unknown"
    fi
}

if [ -z "$LANG" ]; then
    LANG=$(detect_lang)
fi

echo "Language: $LANG"
echo ""

audit_rust() {
    echo "=== Rust Dependency Audit ==="
    echo ""
    
    # List dependencies
    echo "--- Dependencies ---"
    cargo tree -d 2>/dev/null | head -30 || cargo metadata --format-version 1 2>/dev/null | jq -r '.packages[].name' | head -30
    
    echo ""
    
    # Security audit
    if command -v cargo-audit &>/dev/null; then
        echo "--- Security Audit (cargo-audit) ---"
        if [ $FIX -eq 1 ]; then
            cargo audit fix 2>&1 || true
        else
            cargo audit 2>&1 || true
        fi
    else
        echo "Install cargo-audit: cargo install cargo-audit"
    fi
    
    # Outdated
    if command -v cargo-outdated &>/dev/null; then
        echo ""
        echo "--- Outdated Packages ---"
        cargo outdated 2>&1 | head -30 || true
    fi
    
    if [ $UPDATE -eq 1 ]; then
        echo ""
        echo "--- Updating ---"
        cargo update 2>&1
    fi
}

audit_python() {
    echo "=== Python Dependency Audit ==="
    echo ""
    
    # List dependencies
    echo "--- Dependencies ---"
    if [ -f "requirements.txt" ]; then
        cat requirements.txt | head -30
    else
        pip list 2>/dev/null | head -30
    fi
    
    echo ""
    
    # Security audit
    if command -v pip-audit &>/dev/null; then
        echo "--- Security Audit (pip-audit) ---"
        if [ $FIX -eq 1 ]; then
            pip-audit --fix 2>&1 || true
        else
            pip-audit 2>&1 || true
        fi
    elif command -v safety &>/dev/null; then
        echo "--- Security Audit (safety) ---"
        safety check 2>&1 || true
    else
        echo "Install pip-audit: pip install pip-audit"
    fi
    
    # Outdated
    echo ""
    echo "--- Outdated Packages ---"
    pip list --outdated 2>/dev/null | head -20 || true
    
    if [ $UPDATE -eq 1 ]; then
        echo ""
        echo "--- Updating ---"
        pip list --outdated --format=freeze 2>/dev/null | grep -v '^\-e' | cut -d = -f 1 | xargs -n1 pip install -U 2>&1 || true
    fi
}

audit_javascript() {
    echo "=== JavaScript Dependency Audit ==="
    echo ""
    
    if [ ! -f "package.json" ]; then
        echo "No package.json found"
        exit 1
    fi
    
    # List dependencies
    echo "--- Dependencies ---"
    if [ -f "package-lock.json" ]; then
        npm ls --depth=0 2>/dev/null | head -30 || true
    elif [ -f "yarn.lock" ]; then
        yarn list --depth=0 2>/dev/null | head -30 || true
    fi
    
    echo ""
    
    # Security audit
    echo "--- Security Audit ---"
    if [ $FIX -eq 1 ]; then
        npm audit fix 2>&1 || true
    else
        npm audit 2>&1 || true
    fi
    
    # Outdated
    echo ""
    echo "--- Outdated Packages ---"
    npm outdated 2>/dev/null | head -20 || true
    
    if [ $UPDATE -eq 1 ]; then
        echo ""
        echo "--- Updating ---"
        npm update 2>&1
    fi
}

audit_go() {
    echo "=== Go Dependency Audit ==="
    echo ""
    
    if [ ! -f "go.mod" ]; then
        echo "No go.mod found"
        exit 1
    fi
    
    # List dependencies
    echo "--- Dependencies ---"
    go list -m all 2>/dev/null | head -30
    
    echo ""
    
    # Security audit
    if command -v govulncheck &>/dev/null; then
        echo "--- Security Audit (govulncheck) ---"
        govulncheck ./... 2>&1 || true
    else
        echo "Install govulncheck: go install golang.org/x/vuln/cmd/govulncheck@latest"
    fi
    
    if [ $UPDATE -eq 1 ]; then
        echo ""
        echo "--- Updating ---"
        go get -u ./... 2>&1
        go mod tidy 2>&1
    fi
}

case "$LANG" in
    rust|rs) audit_rust ;;
    python|py) audit_python ;;
    javascript|js|typescript|ts) audit_javascript ;;
    go) audit_go ;;
    *)
        echo "Unknown or unsupported language: $LANG"
        echo "Supported: rust, python, javascript, go"
        exit 1
        ;;
esac

echo ""
echo "═══════════════════════════════════════════════════════════════"
